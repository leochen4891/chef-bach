################################################
#
#              Generated by Chef
#
################################################

global
  daemon
  user  haproxy
  group  haproxy
  pidfile  /var/run/haproxy.pid
  log /dev/log local0 info
  # hadoop conf page is more than the default size 16384 bytes
  tune.chksize <%= @haproxy_tune_chksize %>

defaults
  log  global
  maxconn  8000
  source <%="#{node[:bcpc][:management][:vip]}"%>
  mode  http
  option abortonclose
  option tcplog
  option dontlognull
  option nolinger
  option  redispatch
  retries  3
  timeout  http-request 10s
  timeout  queue 1m
  timeout  connect 5s
  timeout  check 10s
  timeout  client 30m
  timeout  server 30m

listen stats <%="#{node[:bcpc][:management][:ip]}"%>:1936
  mode http
  stats enable
  stats uri /
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%="#{get_config('haproxy-stats-user')}"%>:<%="#{get_config!('password',"haproxy-stats","os")}"%>

listen stats-vip <%="#{node[:bcpc][:management][:vip]}"%>:1936
  mode http
  server myself <%="#{node[:bcpc][:management][:ip]}"%>:1936

listen memcached <%="#{node[:bcpc][:management][:vip]}"%>:11211
  mode tcp
  option tcpka
  server myself 127.0.0.1:11211

<% if @mysql_servers.length > 0 -%>
listen mysql-galera <%="#{node[:bcpc][:management][:vip]}"%>:3306
  timeout  client 24h
  timeout  server 24h
  mode tcp
  balance leastconn
  option  tcplog
  option tcpka
  option httpchk
<% @mysql_servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['management']['ip']}:3306 check port 3307 inter 1s rise 1 fall 1 observe layer4 backup" %>
<% end -%>
<% end -%>

<% if @oozie_servers.length > 0 -%>
frontend oozie
  bind <%="#{node[:bcpc][:floating][:vip]}"%>:<%= node['bcpc']['ha_oozie']['port'] %>
  mode http
  default_backend backend_oozie

backend backend_oozie
  balance roundrobin
  mode http
  source <%= node[:bcpc][:floating][:ip] %>
<% @oozie_servers.each do |server| -%>
  <%= "server #{float_host(server[:fqdn])} #{server['bcpc']['floating']['ip']}:11000 check" %>
<% end -%>
<% end -%>

# hdfs conf page
listen hdfs-conf-page <%= @cluster_vip %>:<%= @ha_hdfs_conf_page_port %>
  balance roundrobin
  option httpchk GET /jmx
  http-check expect string tag.HAState"\ :\ "active
  source <%= node[:bcpc][:floating][:ip] %>
  <% @hdfs_servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['floating']['ip']}:#{@ha_hdfs_conf_page_port} check" %>
  <% end -%>

# hbase conf page
listen hbase-conf-page <%= @cluster_vip %>:<%= @ha_hbase_conf_page_port %>
  balance roundrobin
  option httpchk GET /jmx
  http-check expect string tag.isActiveMaster"\ :\ "true
  source <%= node[:bcpc][:floating][:ip] %>
  <% @hbase_servers.each do |server| -%>
  <%= "server #{server['hostname']} #{server['bcpc']['floating']['ip']}:#{@ha_hbase_conf_page_port} check" %>
  <% end -%>
